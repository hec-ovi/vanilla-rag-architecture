# =============================================================================
# Vanilla RAG Architecture - Docker Compose
# =============================================================================
# Production-ready local RAG system with ROCm GPU support
# Services: Ollama (LLM), Backend (FastAPI), Frontend (Vite React)
#
# Quick Start:
#   1. cp .env.template .env
#   2. Edit .env with your host paths and configuration
#   3. mkdir -p ${OLLAMA_MODELS_DIR} ${DATA_DIR}
#   4. docker compose up -d --build
# =============================================================================

services:
  # ===========================================================================
  # Ollama - LLM Inference Service (ROCm GPU)
  # ===========================================================================
  ollama:
    build:
      context: ./ollama
      dockerfile: Dockerfile
    image: vanilla-rag/ollama:latest
    container_name: vanilla-rag-ollama
    privileged: true
    restart: unless-stopped
    ports:
      - "${OLLAMA_PORT:-11434}:11434"
    volumes:
      - ${OLLAMA_MODELS_DIR:-/tmp/ollama-models}:/ollama-models
    environment:
      - OLLAMA_MODEL=${OLLAMA_MODEL:-qwen2.5:14b}
      - OLLAMA_MODELS=/ollama-models
      - OLLAMA_HOST=0.0.0.0:11434
      - OLLAMA_CONTEXT_LENGTH=${OLLAMA_CONTEXT_LENGTH:-8192}
      - OLLAMA_FLASH_ATTENTION=1
      - OLLAMA_KV_CACHE_TYPE=q8_0
      - OLLAMA_KEEP_ALIVE=${OLLAMA_KEEP_ALIVE:-5m}
      - OLLAMA_NUM_PARALLEL=1
      - OLLAMA_MAX_LOADED_MODELS=1
      - HSA_OVERRIDE_GFX_VERSION=11.5.1
      - HIP_VISIBLE_DEVICES=0
      - AMD_SERIALIZE_KERNEL=1
    ipc: host
    healthcheck:
      test: ["CMD", "bash", "-c", "ollama list > /dev/null 2>&1"]
      interval: 30s
      timeout: 10s
      start_period: 120s
      retries: 5
    networks:
      - vanilla-rag-network

  # ===========================================================================
  # Backend - FastAPI Application
  # ===========================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    image: vanilla-rag/backend:latest
    container_name: vanilla-rag-backend
    restart: unless-stopped
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    volumes:
      - ${DATA_DIR:-/tmp/vanilla-rag-data}:/app/data
      - ${OLLAMA_MODELS_DIR:-/tmp/ollama-models}:/ollama-models:ro
    environment:
      - ENVIRONMENT=production
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - BACKEND_HOST=0.0.0.0
      - BACKEND_PORT=8000
      - OLLAMA_BASE_URL=http://ollama:11434
      - OLLAMA_MODEL=${OLLAMA_MODEL:-qwen2.5:14b}
      - VECTOR_DB_TYPE=${VECTOR_DB_TYPE:-faiss}
      - VECTOR_DB_PATH=/app/data/vector_db
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-sentence-transformers/all-MiniLM-L6-v2}
      - RERANKER_MODEL=${RERANKER_MODEL:-cross-encoder/ms-marco-MiniLM-L-6-v2}
      - CHUNK_SIZE=${CHUNK_SIZE:-500}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-100}
      - TOP_K_RETRIEVE=${TOP_K_RETRIEVE:-10}
      - TOP_K_RERANK=${TOP_K_RERANK:-3}
    depends_on:
      ollama:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    networks:
      - vanilla-rag-network

  # ===========================================================================
  # Frontend - Vite React Application
  # ===========================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    image: vanilla-rag/frontend:latest
    container_name: vanilla-rag-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-3000}:80"
    environment:
      - VITE_API_BASE_URL=http://localhost:${BACKEND_PORT:-8000}
    depends_on:
      - backend
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      start_period: 10s
      retries: 3
    networks:
      - vanilla-rag-network

networks:
  vanilla-rag-network:
    driver: bridge
